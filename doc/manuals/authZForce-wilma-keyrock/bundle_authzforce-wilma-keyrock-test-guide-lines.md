#  Integrated Wilma-Keyrock-AuthZForce: non functional test guidelines #

**Wilma** and **Keyrock** by UPM (Universidad Polit√©cnica de Madrid) and **AuthZForce** by Orange are the FIWARE reference implementations of respectively, **PEP Proxy**, **IdM** and **PDP** Generic Enablers, which are available at:
  
-  Wilma: [GitHub repository](https://github.com/ging/fiware-pep-proxy).
-  Keyrock: [GitHub repository](https://github.com/ging/fiware-idm).
-  AuthZForce: [GitHub repository](https://github.com/authzforce).

The description of the non functional tests carried out on the interaction of these implementations is also published via the GitHub repository at [Fiware/test.NonFunctional/tests/authZForce-wilma-keyrock](../../../tests/authZForce-wilma-keyrock/bundle_authzforce-wilma-keyrock-test-cases.md)

## Testing environment ##
The testing HW can be easily set up through a FIWARE Lab, which is based on the cloud operating system OpenStack, and through which it is easy to create and configure a number of machines with the environment requirements needed by each GEri installation, as indicated below. 

-  Wilma:  [requirements](http://fiware-pep-proxy.readthedocs.io/en/latest/admin_guide/#requirements).
-  Keyrock: [requirements](https://forge.fiware.org/plugins/mediawiki/wiki/fiware/index.php/Identity_Management_-_KeyRock_-_Installation_and_Administration_Guide#Requirements).
-  AuthZForce: [requirements](http://authzforce-ce-fiware.readthedocs.io/en/release-5.4.1b/InstallationAndAdministrationGuide.html#system-requirements).


Alternatively a different virtualisation system can be adopted as well as to prepare the overall hardware required, namely all the phisical machines needed for the test, which are:

1. A machine for the deployment of the GEri PEP Proxy Wilma and nmon utility.
2. A machine for the deployment of the GEri IdM Keyrock and nmon utility.
3. A machine for the deployment of the GEri PDP AuthZForce and nmon utility.
4. A machine for JMeter ver 3.0, the tool used to inject load and for simulating the client and collecting the results generated by Wilma.
5. A machine for web server (Apache) to simulate the back-end (dummy) service configured for the proxy to be tested. 

For example, in the latest test related to version 5.3 of the GEri, all the configured VMs in a dedicated FIWARE Lab were equipped with 2 CPU 2,4 GHz with 4GB RAM and 40 GB HD.

## Overall preliminary setup ##

Once the environment necessary for the test described previously at "Testing Environmment" chapter has been setup, the following preliminary steps need to be accomplished before to start the test process:

1. Build and install AuthZForce as described in [GEri owner instructions](http://authzforce-ce-fiware.readthedocs.io/en/release-5.4.1b/InstallationAndAdministrationGuide.html#installation)
2. Build and install Keyrock as described in [GEri owner instructions](https://github.com/ging/fiware-idm#how-to-build-install)
3. Create a new user on Keyrock as described [here](http://fiware-idm.readthedocs.io/en/latest/user_guide.html#logging-in)
4. Once you are logged in with the user of the previous step, create a new application on Keyrock as described [here](http://fiware-idm.readthedocs.io/en/latest/user_guide.html#registering-an-application) paying attention to the following points:
	-  Configure the `Callback URL` attribute with a valid URL which points to a configured web page in the Apache server.
	-  Register a PEP proxy in order to get a `username` and a `password` to be used in Wilma configuration.
	-  Add a new role with a new permission having HTTP verb `GET` and a valid `path` that (joined with `Callback URL`) which points to a configured web page in the Apache server.
5. Build and install Wilma as described in [GEri owner instructions](http://fiware-pep-proxy.readthedocs.io/en/latest/admin_guide/#system-installation).
6. On Wilma server, in the file config.js set the following parameters:
	- config.username = `PEP proxy username` obtained in the Keyrock application configuration.
	- config.password = `PEP proxy password` obtained in the Keyrock application configuration.
	- config.app_host=`<apache hostname or ip address>`
	- config.cache_time = `0` in order to disable Wilma caching and force Wilma-Keyrock interaction for each request;


## Test execution - Authentication##

###Preliminary setup###
1. Get a valid access token applying the procedure described [here](http://fiware-idm.readthedocs.io/en/latest/oauth2.html#oauth2-authentication)

2. In the file `Security-Bundle-Resource-User-Authorization-50threads-1800sec.jmx` apply the following changes:
	- Set the value related to the argument `HOST` with the Wilma host name or IP address value. The precise point where to apply this change can be easily found by searching the string `#wilma hostname or IP#` and replacing it with the appropriate value.
	- Set the value related to the parameter `X-Auth-Token` with value obtained in the in the previous step. The precise point where to apply this change can be easily found by searching the string `#token#` and replacing it with the appropriate value.
	- Set the value related to the URL path with that one used in the user role configuration during Keyrock application setup. The precise point where to apply this change can be easily found by searching the string `#path#` and replacing it with the appropriate value.

###Testing step by step###

1. Put the file `Security-Bundle-Resource-User-Authorization-50threads-1800sec.jmx` in a generic working directory of the user logged into the JMeter server.

2. In order to collect system CPU, memory and network information for 300 times each 10 seconds (3.000 seconds), start `nmon` utility with the command `nmon -s10 -c300 -f` in each of the servers involved, namely: Wilma, Keyrock and AuthZForce; output files with `.nmon` extension will be generated.

3. From a shell opened on JMeter server, start the test using the command `<jmeter absolute path>/jmeter.sh -n -t<working directory absolute path>/Security-Bundle-Resource-User-Authorization-50threads-1800sec.jmx`.  The output file `Security-Bundle-Resource-User-Authorization-50threads-1800sec.csv` will be created in the current directory.
  
4. Collect the result files once the JMeter sessions has finished (30 minutes).

### Expected results ###

This test is intended to monitor the behavior of Authentication API with a growing input workload and with a stable input workload.

More in detail, these tests involve the assessment of different non functional metrics such as:

1. Response times for <n> concurrent threads
2. Number of responses per second
3. Number of Bytes per second (Throughput)
4. HTTP response codes
5. Error rate
6. Maximum threads number handled
7. CPU usage
8. Memory usage
9. Network traffic

These values can be extracted, on the one hand from the output (CSV file `Security-Bundle-Resource-User-Authorization-50threads-1800sec.csv`) of the execution of the JMeter test plan file (`Security-Bundle-Resource-User-Authorization-50threads-1800sec.jmx`), on the other hand from a tool for monitoring system resource usage such as [nmon](http://nmon.sourceforge.net/).

