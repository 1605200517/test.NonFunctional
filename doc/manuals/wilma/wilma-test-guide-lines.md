#  PEP Proxy Wilma: non functional test guidelines #

Wilma by UPM (Universidad Polit√©cnica de Madrid) is the FIWARE reference implementation of PEP Proxy Generic Enabler and it is available at its [GitHub repository](https://github.com/ging/fiware-pep-proxy). The description of the non functional tests carried out on this implementation is also published via the GitHub repository at [Fiware/test.NonFunctional/tests/wilma](../../../tests/wilma/wilma-test-cases.md)

## Testing environment ##
The testing HW can be easily set up through a FIWARE Lab, which is based on the cloud operating system OpenStack, and through which it is easy to create and configure a number of machines with the environment [requirements](http://fiware-pep-proxy.readthedocs.io/en/latest/admin_guide/#requirements)  required by the GEri installation. Alternatively a different virtualisation system can be adopted as well as to prepare the overall hardware required, namely all the phisical machines needed for the test, which are:

1. A machine for the deployment of the GEri PEP Proxy Wilma and nmon utility.
2. A machine for the deployment of the GEri IdM Keyrock.
3. A machine for JMeter ver 3.0, the tool used to inject load and for simulating the client and collecting the results generated by Wilma.
4. A machine for web server (Apache) to simulate the back-end service (dummy service) connected to and mediated by the proxy to be tested.

For example, in the latest test related to version 5.3 of the GEri, all the configured VMs in a dedicated FIWARE Lab were equipped with 2 CPU 2,4 GHz with 4GB RAM and 40 GB HD.

## Overall preliminary setup ##

Once the environment necessary for the test described previously at "Testing Environmment" chapter has been setup, the following preliminary steps need to be accomplished before to start the test process:

1. Build and install Keyrock as described in [GEri owner instructions](https://github.com/ging/fiware-idm#how-to-build-install)
2. Create a new user on Keyrock as described [here](http://fiware-idm.readthedocs.io/en/latest/user_guide.html#logging-in)
3.  Once you are logged in with the user of the previous step, create a new application on Keyrock as described [here](http://fiware-idm.readthedocs.io/en/latest/user_guide.html#registering-an-application) paying attention to configure the `Callback URL` attribute with a valid URL which points to an existing web page in the Apache server. Moreover, in the application section, it's needed to register a PEP proxy in order to get a valid couple of `username` and `password` to be used in the Wilma configuration.
4. Build and install Wilma as described in [GEri owner instructions](http://fiware-pep-proxy.readthedocs.io/en/latest/admin_guide/#system-installation).
5. On Wilma server, in the file config.js set the following parameters:
	- config.username = PEP proxy username obtained in the Keyrock application configuration.
	- config.password = PEP proxy password obtained in the Keyrock application configuration.
	- config.app_host=`<apache hostname or ip address>`


## Test execution - Authentication##

###Preliminary setup###
1. Get a valid access token applying the procedure described [here](http://fiware-idm.readthedocs.io/en/latest/oauth2.html#oauth2-authentication)

2. In the file `pepwilma-authenticate-300threads-2400sec.jmx` apply the following changes:
	- Set the value related to the argument `HOST` with the Wilma host name or IP address value. The precise point where to apply this change can be easily found by searching the string `#wilma hostname or IP#` and replacing it with the appropriate value.
	- Set the value related to the parameter `X-Auth-Token` with value obtained in the in the previous step. The precise point where to apply this change can be easily found by searching the string `#token#` and replacing it with the appropriate value.

###Testing step by step###

1. Put the file `pepwilma-authenticate-300threads-2400sec.jmx` in a generic working directory of the user logged into JMeter server.
2. In order to collect system CPU, memory and network information for 300 times each 10 seconds (3.000 seconds), start `nmon` utility in the Wilma server using the command `nmon -s10 -c300 -f`. An output file having extension `.nmon` will be generated.
3. From a shell opened on JMeter server, start the test using the command `<jmeter absolute path>/jmeter.sh -n -t<working directory absolute path>/pepwilma-authenticate-300threads-2400sec.jmx`.  The output file `pepwilma-authenticate-300threads-2400sec.jmx.csv` will be created in the current directory  
4. Collect the result files once the JMeter sessions has finished (40 minutes).

### Expected results ###

This test is intended to monitor the behavior of Authentication API with a growing input workload and with a stable input workload.

More in detail, these tests involve the assessment of different non functional metrics such as:

1. Response times for <n> concurrent threads
2. Number of responses per second
3. Number of Bytes per second (Throughput)
4. HTTP response codes
5. Error rate
6. Maximum threads number handled
7. CPU usage
8. Memory usage
9. Network traffic

These values can be extracted, on the one hand from the output (CSV file `pepwilma-authenticate-300threads-2400sec.csv`) of the execution of the JMeter test plan file (`pepwilma-authenticate-300threads-2400sec.jmx`), on the other hand from a tool for monitoring system resource usage such as [nmon](http://nmon.sourceforge.net/).

## Test execution - Authentication (stability test)##

###Preliminary setup###
1. Get a valid access token applying the procedure described [here](http://fiware-idm.readthedocs.io/en/latest/oauth2.html#oauth2-authentication)

2. In the file `pepwilma-authenticate-80threads-28800sec.jmx` apply the following changes:
	- Set the value related to the argument `HOST` with the Wilma host name or IP address value. The precise point where to apply this change can be easily found by searching the string `#wilma hostname or IP#` and replacing it with the appropriate value.
	- Set the value related to the parameter `X-Auth-Token` with value obtained in the in the previous step. The precise point where to apply this change can be easily found by searching the string `#token#` and replacing it with the appropriate value. 

###Testing step by step###

1. Put the file `pepwilma-authenticate-80threads-28800sec.jmx` in a generic working directory of the user logged into the JMeter server.
2. In order to collect system CPU, memory and network information for 3.000 times each 10 seconds (30.000 seconds), start `nmon` in Wilma server using the command `nmon -s10 -c3000 -f`. An output file having extension `.nmon` will be generated.
3. From a shell opened on JMeter server, start the test using the command `<jmeter absolute path>/jmeter.sh -n -t<working directory absolute path>/pepwilma-authenticate-80threads-28800sec.jmx`.  The output file `pepwilma-authenticate-80threads-28800sec.csv` will be created in the current directory  
4. Collect the result files once the JMeter sessions has finished (8 hours).

### Expected results ###

This test is intended to monitor the behavior of Authentication API with a stable input workload over a long period of time.

More in detail, this test involves the assessment of different non functional metrics such as:

1. Response times for <n> concurrent threads
2. Number of responses per second
3. Number of Bytes per second (Throughput)
4. HTTP response codes
5. Error rate
6. Maximum threads number handled
7. CPU usage
8. Memory usage
9. Network traffic

These values can be extracted, on the one hand from the output (CSV file `pepwilma-authenticate-80threads-28800sec.csv`) of the execution of the JMeter test plan file (`pepwilma-authenticate-80threads-28800sec.jmx`), on the other hand from a tool for monitoring system resource usage such as [nmon](http://nmon.sourceforge.net/).



